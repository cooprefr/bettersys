# =============================================================================
# Linux Kernel Network Tuning for Low-Latency Market Data Feeds
# /etc/sysctl.d/99-market-data.conf
#
# Deploy: sudo cp 99-market-data.conf /etc/sysctl.d/ && sudo sysctl -p /etc/sysctl.d/99-market-data.conf
# =============================================================================

# === Socket Buffer Sizing ===
# Accommodate TLS record buffering + WebSocket framing without blocking
# Values: min, default, max (in bytes)

# Core buffer limits (16MB max, 4MB default)
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 4194304
net.core.wmem_default = 4194304

# TCP-specific buffers
net.ipv4.tcp_rmem = 4096 1048576 16777216
net.ipv4.tcp_wmem = 4096 262144 16777216

# Increase backlog for burst handling
net.core.netdev_max_backlog = 50000
net.core.somaxconn = 4096

# === Busy-Poll Settings ===
# Reduce latency by polling sockets in userspace before sleeping
# Trade CPU for latency - use cautiously
net.core.busy_poll = 50
net.core.busy_read = 50

# === TCP Optimizations ===

# Reduce FIN_WAIT time (faster socket recycling)
net.ipv4.tcp_fin_timeout = 15

# Enable window scaling (required for large buffers)
net.ipv4.tcp_window_scaling = 1

# Enable timestamps (RTT estimation, PAWS protection)
net.ipv4.tcp_timestamps = 1

# Selective ACK (reduces retransmit volume on loss)
net.ipv4.tcp_sack = 1

# Faster recovery from packet loss
net.ipv4.tcp_early_retrans = 3

# CRITICAL: Disable slow start after idle (keeps congestion window warm)
# This prevents latency spikes on resumed connections
net.ipv4.tcp_slow_start_after_idle = 0

# MTU probing (avoids fragmentation)
net.ipv4.tcp_mtu_probing = 1

# === Congestion Control ===
# BBR is model-based (not loss-based), better for WAN with variable latency
# For DC/LAN: cubic is fine
# Uncomment ONE of the following:
# net.ipv4.tcp_congestion_control = bbr
net.ipv4.tcp_congestion_control = cubic

# For BBR, also set:
# net.core.default_qdisc = fq

# === Port Range ===
# Increase ephemeral port range for high connection counts
net.ipv4.ip_local_port_range = 1024 65535

# === Memory Pressure ===
# Prevent premature memory pressure signaling
net.ipv4.tcp_mem = 786432 1048576 1572864

# === RPS Flow Table ===
# Size of the per-CPU flow table for RPS (must be power of 2)
net.core.rps_sock_flow_entries = 32768

# === Timestamping ===
# Enable hardware timestamping if available (for latency measurement)
net.core.netdev_budget = 600
net.core.netdev_budget_usecs = 8000

# === ARP Cache ===
# Increase ARP cache for environments with many endpoints
net.ipv4.neigh.default.gc_thresh1 = 4096
net.ipv4.neigh.default.gc_thresh2 = 8192
net.ipv4.neigh.default.gc_thresh3 = 16384

# === Keep-Alive ===
# Faster detection of dead connections
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_intvl = 10
net.ipv4.tcp_keepalive_probes = 6

# === SYN Handling ===
# Protect against SYN floods while maintaining low latency
net.ipv4.tcp_max_syn_backlog = 8192
net.ipv4.tcp_syncookies = 1
